<!DOCTYPE html>
<html>
<head>
    <title>Arma3 - Adler-AAR</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore-min.js"></script>
    <style>
        #map {
            min-height: 400px;
            min-width: 400px;
            background-color: pink;
        }

        html, body, #map {
            height: 100%;
        }
    </style>
</head>
<body>
<div id="map">
    <div id="nojs">
        If you can see this message, there is a problem with JavaScript
    </div>
</div>
<script>

    var dataUrl = 'http://gruppe-adler.de:12302/';
    var initialZoom = 7;
    var tileSize = 256;
    // pixelCoordinate = worldCoordinate * Math.pow(2, zoomLevel)

    function log2(x) {
        return Math.log(x) / Math.LN2;
    }

    var armaMapType = new google.maps.ImageMapType({
                getTileUrl: function (coord, zoom) {

                    var x = coord.x;
                    var y = coord.y;

                    window.coord = coord;
//console.log(coord);
                    var numTiles = Math.pow(2, zoom - 1);
/*
                    if (coord.y < 0 || coord.y >= numTiles) {
                        return null;
                    }
                    if (coord.x < 0 || coord.x >= numTiles) {
                        return null;
                    }
*/

                    var tileZoom = zoom - initialZoom;
                    x = x - numTiles;
                    y = y - numTiles;
                    console.log('map coords ' + coord.x + ' / ' + coord.y + ', zoom: ' + zoom + '. looking for tiles ' + tileZoom + ' / ' + x + ' / ' + y);
                    var myY = Math.pow(2, tileZoom) - (y + 1);

                    var baseURL = 'stratis_18022/';
                    baseURL += [tileZoom, x, myY].join('/') + '.png';
                    return baseURL;
                },
                tileSize: new google.maps.Size(tileSize, tileSize),
                isPng: true,
                minZoom: initialZoom,
                maxZoom: initialZoom + 7,
                name: 'Stratis T10'
            }
    );

    function init() {

        window.map = new google.maps.Map(
                document.querySelector('#map'),
                {
                    zoom: 7,
                    center: new google.maps.LatLng(0, 0),
                    mapTypeControlOptions: {
                        mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'armaMapType']
                    }

                }
        );

        map.mapTypes.set('map', armaMapType);
        map.setMapTypeId('map');


    }
    google.maps.event.addDomListener(window, 'load', init);

    /**
     * in-game coordinates are in meters, with 0,0 at south west corner of map
     * @param x
     * @param y
     * @param z
     *
     * For simplicity's sake, I will translate
     *
     */
    function gameCoordsToLatLng(x, y, z) {
        return new google.maps.LatLng(x / 1000, y / 1000);
    }

    function latLngToGameCoords(latLng) {
        return {
            x: latLng.lat() * 1000,
            y: latLng.lng() * 1000,
            z: 0
        };
    }

    setInterval(function () {
        var markers = {};

        $.get(dataUrl, function (data) {
            _.each(data, function (val, name) {
                var m = markers[name] || new google.maps.Marker({
                    position: {lat: 0, lng: 0},
                    map: map,
                    title: name
                 });
                m.setPosition(gameCoordsToLatLng(val[0], val[1]));

                markers[name] = m;
            });
        });
    }, 2000);

</script>
</body>
</html>